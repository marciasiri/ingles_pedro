<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Prevents search engines from indexing the game or following links -->
    <meta name="robots" content="noindex, nofollow">
    <title>English Vocabulary Listener Game</title>
    <!-- Load Font Awesome for the speaker icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Load Tailwind CSS for utility classes and layout -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles for Game Aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dark Gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .game-container {
            background: #ffffff;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            max-width: 600px;
            width: 100%;
            border: 4px solid #3b82f6; /* Blue border */
        }

        .category-grid {
            display: grid;
            grid-template-columns: 1fr; /* Default: 1 column for mobile */
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Desktop/Tablet: Switch to grid only when screen is wider */
        @media (min-width: 640px) {
            .category-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }

        .game-button {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-transform: uppercase;
            box-shadow: 0 4px #1e40af; /* Default shadow */
        }
        .game-button:active { 
            box-shadow: 0 0; 
            transform: translateY(4px); 
        }

        /* --- STYLED NEXT BUTTON (ARROW SHAPE) --- */
        .next-btn-styled {
            background-color: #6366f1 !important; /* Indigo-500 */
            color: white !important;
            padding-right: 2rem !important;
            padding-left: 1rem !important;
            /* Creates a right-pointing arrow shape */
            clip-path: polygon(0% 0%, 85% 0%, 100% 50%, 85% 100%, 0% 100%);
            box-shadow: none !important; /* Shadows don't work well with clip-path */
            border-left: 6px solid #4338ca; /* Indigo-700 for a bit of depth */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: auto !important;
            margin: 1rem auto 0 !important;
        }
        .next-btn-styled:active {
            transform: translateX(4px);
        }

        /* --- LEVEL BUTTON COLORS --- */
        
        /* Level 1 (Default/Not complete): Light Blue */
        .game-button.default {
            background-color: #38bdf8; /* Sky-400 (Light Blue) */
            color: white;
            box-shadow: 0 4px #0284c7; /* Sky-700 */
        }
        .game-button.default:hover { background-color: #0ea5e9; } 

        /* Level 2 (Unlocked/Complete Level 1): Dark Blue */
        .game-button.unlocked {
            background-color: #1e3a8a; /* Blue-900 (Dark Blue) */
            color: white;
            box-shadow: 0 4px #1e3a8a; 
        }
        .game-button.unlocked:hover { background-color: #172554; }

        /* Level 3 (Ready for L3/Mastered): Dark Green */
        .game-button.mastered {
            background-color: #047857; /* Emerald-700 (Dark Green) */
            color: white;
            box-shadow: 0 4px #047857; 
        }
        .game-button.mastered:hover { background-color: #047857; }

        /* Level 4 (Mastered on Homepage): Orange */
        .game-button.mastered-final {
            background-color: #f97316; /* Orange-600 */
            color: white;
            box-shadow: 0 4px #c2410c; /* Orange-800 */
        }
        .game-button.mastered-final:hover { background-color: #ea580c; }
        
        /* --- LEVEL TITLE COLORS --- */

        .level-title-container {
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            color: white; /* FIX: Ensure text is white */
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        #current-theme-title-1 {
            background-color: #38bdf8; /* Light Blue */
        }
        #current-theme-title-2 {
            background-color: #1e3a8a; /* Dark Blue */
        }
        #current-theme-title-3, #current-theme-title-mastered {
            background-color: #047857; /* Dark Green */
        }
        
        /* TTS Button (Main Level 1 Speaker) */
        .tts-button {
            padding: 1rem;
            background-color: #10b981; /* Emerald */
            color: white;
            border-radius: 9999px; /* Round */
            width: 80px;
            height: 80px;
            box-shadow: 0 6px #059669;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .tts-button:active {
            box-shadow: 0 0 #059669;
            transform: translateY(6px);
        }
        
        #tts-icon {
            font-size: 2.5rem;
            line-height: 1; 
            display: block;
        }

        /* Microphone Button (Level 3) */
        #mic-btn-3 {
            background-color: #ef4444; /* Red */
            box-shadow: 0 6px #b91c1c; /* Darker Red */
        }
        #mic-btn-3.recording {
            background-color: #f59e0b; /* Amber */
            box-shadow: 0 6px #d97706;
        }

        /* Image Styles (Level 1 Options & Level 2/3 Target) */
        .image-option, #target-image-2, #target-image-3 {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: contain;
            border: 4px solid #e5e7eb;
            border-radius: 0.75rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* L1 Images are clickable */
        .image-option {
            cursor: pointer;
        }
        /* L2/L3 Target Images are NOT clickable */
        #target-image-2, #target-image-3 {
            cursor: initial; /* FIX: Remove pointer cursor */
        }
        
        /* Border styles for Level 1 (Image options) */
        .image-option.correct {
            border-color: #10b981; 
            border-width: 6px;
            box-shadow: 0 0 20px #10b981;
        }
        .image-option.incorrect {
            border-color: #ef4444; 
            border-width: 6px;
            box-shadow: 0 0 10px #ef4444;
        }

        /* Button styles for Level 2 options */
        .level2-play-btn {
            background-color: #4f46e5; /* Indigo */
            color: white;
            box-shadow: 0 4px #3730a3;
            height: 48px;
            font-size: 1.25rem; /* Increased for better icon visibility */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .level2-play-btn:active {
             box-shadow: 0 0 #3730a3;
             transform: translateY(4px);
        }
        .level2-play-btn .fas {
            font-size: 1.5rem;
        }
        
        .level2-select-btn {
            background-color: #f59e0b; /* Amber-500 */
            color: white;
            box-shadow: 0 4px #b45309; /* Amber-700 */
            height: 48px;
            font-size: 1.5rem; /* Increased for better icon visibility */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Level 2 Answer Feedback Colors (applied to Select button) */
        .level2-select-btn.correct {
            background-color: #10b981 !important;
            box-shadow: 0 4px #059669;
        }
        .level2-select-btn.incorrect {
            background-color: #ef4444 !important;
            box-shadow: 0 4px #b91c1c;
        }

        /* NEW: Level 3 Hint button style */
        #tts-hint-btn-3 {
            background-color: #4f46e5; /* Indigo */
            box-shadow: 0 6px #3730a3;
        }
        
        /* Fixed Feedback Button Container for Vertical Stacking */
        .feedback-button-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .feedback-button-container .game-button {
            width: 100%;
            margin: 0; /* Override any margin set previously */
        }
        
        /* FIX: Ensure skip button text is white */
        #skip-level3-btn {
            color: white; 
        }

        /* --- PROGRESS SCALE STYLES --- */
        .progress-scale-container {
            flex-grow: 1;
            margin-left: 0.75rem;
            background-color: #e5e7eb;
            height: 0.6rem;
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
            min-width: 60px;
            max-width: 120px;
            border: 1px solid #d1d5db;
        }
        #progress-scale-fill {
            height: 100%;
            background-color: #10b981; /* Emerald-500 */
            transition: width 0.5s ease-out;
            width: 0%;
        }
    </style>
</head>
<body>

<div class="game-container">
    <header class="text-center pb-4 mb-4 border-b-2 border-gray-100">
        <h1 id="main-title" class="text-3xl font-extrabold text-gray-800">Let's learn English</h1>

        <div class="mt-3 flex justify-between items-center px-2">
            <div class="flex items-center flex-1">
                <span class="text-base sm:text-lg font-bold text-gray-700 whitespace-nowrap">Score: <span id="score">0.0</span></span>
                <div class="progress-scale-container" id="score-scale-box">
                    <div id="progress-scale-fill"></div>
                </div>
            </div>
            <button id="back-to-home-btn" class="text-xs sm:text-sm text-blue-600 hover:text-blue-800 font-semibold hidden ml-2">‚Üê Themes</button>
        </div>
    </header>

    <!-- MAIN VIEWS CONTAINER -->
    <div id="game-screens">
        
        <!-- 1. HOME SCREEN (CATEGORY SELECTION) -->
        <div id="home-screen" class="p-4">
            <div id="category-list" class="category-grid"></div>
        </div>

        <!-- 2. LEVEL 1 QUIZ SCREEN (Audio to Image) -->
        <div id="level1-screen" class="hidden text-center p-4">
            <h2 id="current-theme-title-1" class="text-2xl font-bold level-title-container">Loading...</h2>

            <p class="text-lg font-semibold text-gray-600 mb-6">
                Question <span id="current-question-count-1">0</span> / <span id="total-question-count-1">0</span>
            </p>

            <button id="tts-btn-1" class="tts-button">
                <span id="tts-icon-1">
                    <i class="fas fa-volume-up"></i>
                </span>
            </button>
            <p id="l1-instruction" class="text-lg font-semibold text-gray-600 mb-6">Tap to hear the word!</p>

            <div id="image-options-container" class="grid grid-cols-3 gap-4"></div>

            <div id="feedback-area-1" class="mt-6 min-h-12">
                <p id="feedback-text-1" class="text-lg font-bold"></p>
                 <div class="feedback-button-container">
                    <button id="next-level1-btn" class="game-button next-btn-styled hidden">
                        NEXT WORD <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 3. LEVEL 2 QUIZ SCREEN (Image to Audio) -->
        <div id="level2-screen" class="hidden text-center p-4">
            <h2 id="current-theme-title-2" class="text-2xl font-bold level-title-container">Loading...</h2>
            
            <p class="text-lg font-semibold text-gray-600 mb-6">
                Question <span id="current-question-count-2">0</span> / <span id="total-question-count-2">0</span>
            </p>

            <div class="h-48 flex justify-center items-center mb-6">
                <img id="target-image-2" class="max-h-full max-w-full rounded-lg shadow-xl border-4 border-gray-200" src="" alt="Target Image">
            </div>

            <p id="l2-instruction" class="text-lg font-semibold text-gray-600 mb-6">Hear and select the word matching the image</p>

            <div id="audio-options-container" class="grid grid-cols-3 gap-4">
                <div class="flex flex-col gap-2">
                    <button class="level2-play-btn game-button"><i class="fas fa-volume-up"></i></button>
                    <button class="level2-select-btn game-button"><i class="fas fa-check-square"></i></button>
                </div>
                <div class="flex flex-col gap-2">
                    <button class="level2-play-btn game-button"><i class="fas fa-volume-up"></i></button>
                    <button class="level2-select-btn game-button"><i class="fas fa-check-square"></i></button>
                </div>
                <div class="flex flex-col gap-2">
                    <button class="level2-play-btn game-button"><i class="fas fa-volume-up"></i></button>
                    <button class="level2-select-btn game-button"><i class="fas fa-check-square"></i></button>
                </div>
            </div>

            <div id="feedback-area-2" class="mt-6 min-h-12">
                <p id="feedback-text-2" class="text-lg font-bold"></p>
                <div class="feedback-button-container">
                    <button id="next-level2-btn" class="game-button next-btn-styled hidden">
                        NEXT WORD <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 4. LEVEL 3 QUIZ SCREEN (Speech Recognition) -->
        <div id="level3-screen" class="text-center p-4 hidden">
            <h2 id="current-theme-title-3" class="text-2xl font-bold level-title-container">Loading...</h2>
            <p class="text-lg font-semibold text-gray-600 mb-6">
                Question <span id="current-question-count-3">0</span> / <span id="total-question-count-3">0</span>
            </p>

            <div class="h-48 flex justify-center items-center mb-6">
                <img id="target-image-3" class="max-h-full max-w-full rounded-lg shadow-xl border-4 border-gray-200" src="" alt="Target Image">
            </div>

            <p id="l3-instruction" class="text-lg font-semibold text-gray-600 mb-6">Pronounce the word matching the image:</p>

            <div class="flex justify-center items-center space-x-6">
                <button id="mic-btn-3" class="tts-button">
                    <span id="mic-icon-3"><i class="fas fa-microphone"></i></span>
                </button>
                <button id="tts-hint-btn-3" class="tts-button !bg-indigo-500">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>

            <p id="recognition-status" class="text-sm text-gray-500 mt-2 min-h-6">Pronounce the word you see.</p>

            <div id="feedback-area-3" class="mt-6 min-h-12">
                <p id="feedback-text-3" class="text-lg font-bold"></p>
                <div class="feedback-button-container">
                    <button id="skip-level3-btn" class="game-button bg-red-500 hover:bg-red-600 active:bg-red-700 hidden">SKIP WORD</button>
                    <button id="next-level3-btn" class="game-button next-btn-styled hidden">
                        NEXT WORD <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 5. LEVEL COMPLETE SCREEN -->
        <div id="level-complete-screen" class="text-center p-4 hidden">
            <h2 class="text-3xl font-bold text-green-600 mb-4">LEVEL COMPLETE!</h2>
            <p class="text-xl text-gray-700 mb-6">You successfully completed <span id="completed-theme"></span>!</p>
            <p class="text-lg text-gray-600 mb-8">Score gained in this level: <span id="theme-score" class="font-bold text-purple-600">0.0</span></p>
            <button class="game-button default w-full mb-3" onclick="App.showHomeScreen()">BACK TO THEME SELECTION</button>
            <p class="text-sm text-gray-500 mt-4"><span id="next-level-message"></span></p>
        </div>
    </div>
</div>

<script>
    const PROGRESS_KEY = 'vocab_game_progress'; 

    // --- SPEECH RECOGNITION SETUP ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1; 
    }

    const BASE_IMAGE_URL = "https://regine-lambrecht.github.io/ingles_Mikael/images/";
    const WORD_DATA_DETAILS = {
        "Animals": [
            { word: "Bird", ext: ".png" }, { word: "Cat", ext: ".png" }, { word: "Chicken", ext: ".png" },
            { word: "Cow", ext: ".png" }, { word: "Dog", ext: ".jpg" },
            { word: "Duck", ext: ".jpg" }, { word: "Elephant", ext: ".jpg" }, { word: "Fish", ext: ".png" }, { word: "Frog", ext: ".jpg" },
            { word: "Horse", ext: ".jpg" }, { word: "Lion", ext: ".jpg" }, { word: "Monkey", ext: ".jpg" },
            { word: "Pig", ext: ".jpg" }, { word: "Rabbit", ext: ".jpg" }, { word: "Snake", ext: ".jpg" },
            { word: "Turtle", ext: ".jpg" }
        ],
        "Body": [
            { word: "Chest", ext: ".png" }, { word: "Ear", ext: ".png" }, { word: "Eye", ext: ".png" },
            { word: "Foot", ext: ".png" }, { word: "Hair", ext: ".png" }, { word: "Hand", ext: ".png" },
            { word: "Knee", ext: ".png" }, { word: "Mouth", ext: ".png" }, { word: "Neck", ext: ".png" },
            { word: "Nose", ext: ".png" }
        ],
        "Clothes": [
            { word: "Hat", ext: ".jpg" }, { word: "Shoes", ext: ".png" }, { word: "T-shirt", ext: ".png" },
            { word: "Belt", ext: ".png" }, { word: "Boxer", ext: ".png" }, { word: "Cap", ext: ".png" },
            { word: "Jacket", ext: ".png" }, { word: "Pants", ext: ".png" }, { word: "Pijama", ext: ".png" },
            { word: "Shorts", ext: ".png" }, { word: "Skirt", ext: ".png" }, { word: "Socks", ext: ".png" },
            { word: "Sweater", ext: ".jpg" }
        ],
        "Colours": [
            { word: "Black", ext: ".png" }, { word: "Dark blue", ext: ".png" }, { word: "Green", ext: ".png" },
            { word: "Light blue", ext: ".png" }, { word: "Orange", ext: ".png" }, { word: "Pink", ext: ".png" },
            { word: "Purple", ext: ".png" }, { word: "Red", ext: ".png" }, { word: "White", ext: ".png" },
            { word: "Yellow", ext: ".png" }
        ],
        "Family": [
            { word: "Brother", ext: ".png" }, { word: "Father", ext: ".png" }, { word: "Grand-father", ext: ".png" },
            { word: "Grand-mother", ext: ".png" }, { word: "Mother", ext: ".png" }, { word: "Sister", ext: ".png" }
        ],
        "Food": [
            { word: "Apple", ext: ".jpg" }, { word: "Banana", ext: ".png" }, { word: "Bread", ext: ".jpg" },
            { word: "Carrot", ext: ".png" }, { word: "Cherry", ext: ".png" }, { word: "Chocolate", ext: ".png" },
            { word: "Grapes", ext: ".jpg" }, { word: "Ice cream", ext: ".png" }, { word: "Lemon", ext: ".jpg" },
            { word: "Meal", ext: ".jpg" }, { word: "Oil", ext: ".jpg" }, { word: "Onion", ext: ".png" },
            { word: "Orange", ext: ".png" }, { word: "Orange juice", ext: ".png" }, { word: "Pear", ext: ".png" },
            { word: "Pepper", ext: ".png" }, { word: "Potato", ext: ".jpg" }, { word: "Rice", ext: ".jpg" },
            { word: "Salad", ext: ".png" }, { word: "Salt", ext: ".png" }, { word: "Strawberry", ext: ".jpg" },
            { word: "Tomato", ext: ".jpg" }, { word: "Water", ext: ".jpg" }
        ],
        "House": [
            { word: "Bathroom", ext: ".png" }, { word: "Bedroom", ext: ".png" }, { word: "Dining room", ext: ".png" },
            { word: "Door", ext: ".jpg" }, { word: "Kitchen", ext: ".png" }, { word: "Living room", ext: ".png" },
            { word: "Office", ext: ".png" }, { word: "Toilet", ext: ".png" }, { word: "Window", ext: ".jpg" }
        ],
        "Numbers": [
            { word: "One", ext: ".png" }, { word: "Two", ext: ".png" }, { word: "Three", ext: ".png" },
            { word: "Four", ext: ".png" }, { word: "Five", ext: ".png" }, { word: "Six", ext: ".png" },
            { word: "Seven", ext: ".png" }, { word: "Eight", ext: ".png" }, { word: "Nine", ext: ".png" },
            { word: "Ten", ext: ".png" }, { word: "Eleven", ext: ".png" }, { word: "Twelve", ext: ".png" },
            { word: "Thirteen", ext: ".png" }, { word: "Fourteen", ext: ".png" }, { word: "Fifteen", ext: ".png" },
            { word: "Sixteen", ext: ".png" }, { word: "Seventeen", ext: ".png" }, { word: "Eighteen", ext: ".png" },
            { word: "Nineteen", ext: ".png" }, { word: "Twenty", ext: ".png" }, { word: "Thirty", ext: ".png" },
            { word: "Fourty", ext: ".png" }, { word: "Fifty", ext: ".png" }, { word: "Sixty", ext: ".png" },
            { word: "Seventy", ext: ".png" }, { word: "Eighty", ext: ".png" }, { word: "Ninety", ext: ".png" },
            { word: "First", ext: ".png" }, { word: "Second", ext: ".png" }, { word: "Third", ext: ".png" },
            { word: "Fourth", ext: ".png" }, { word: "Fifth", ext: ".png" }, { word: "Sixth", ext: ".png" },
            { word: "Seventh", ext: ".png" }, { word: "Eighth", ext: ".png" }, { word: "Nineth", ext: ".png" }
        ],
        "Objects": [
            { word: "Ball", ext: ".jpg" }, { word: "Book", ext: ".jpg" }, { word: "Bowl", ext: ".jpg" },
            { word: "Chair", ext: ".jpg" }, { word: "Fork", ext: ".jpg" }, { word: "Glass", ext: ".jpg" },
            { word: "Key", ext: ".jpg" }, { word: "Pencil", ext: ".jpg" }, { word: "Plate", ext: ".png" },
            { word: "Spoon", ext: ".jpg" }, { word: "Sword", ext: ".jpg" }, { word: "Table", ext: ".png" },
            { word: "Watch", ext: ".jpg" }
        ],
        "Opposites": [
            { word: "Bad", ext: ".png" }, { word: "Cheap", ext: ".png" }, { word: "Cold", ext: ".png" },
            { word: "Day", ext: ".png" }, { word: "Empty", ext: ".png" }, { word: "Expensive", ext: ".png" },
            { word: "Fast", ext: ".jpg" }, { word: "Fat", ext: ".png" }, { word: "Full", ext: ".png" },
            { word: "Future", ext: ".png" }, { word: "Go down", ext: ".png" }, { word: "Go up", ext: ".jpg" },
            { word: "Good", ext: ".png" }, { word: "Happy", ext: ".png" }, { word: "Heavy", ext: ".png" },
            { word: "High", ext: ".png" }, { word: "Hot", ext: ".png" }, { word: "Left", ext: ".png" },
            { word: "Light", ext: ".jpg" }, { word: "Low", ext: ".png" }, { word: "Next", ext: ".png" },
            { word: "Night", ext: ".png" }, { word: "Old", ext: ".png" }, { word: "Past", ext: ".png" },
            { word: "Previous", ext: ".png" }, { word: "Right", ext: ".png" }, { word: "Sad", ext: ".png" },
            { word: "Slow", ext: ".jpg" }, { word: "Small", ext: ".png" }, { word: "Start", ext: ".png" },
            { word: "Stop", ext: ".png" }, { word: "Tall", ext: ".png" }, { word: "Thin", ext: ".png" },
            { word: "Turn off", ext: ".png" }, { word: "Turn on", ext: ".png" }, { word: "Wrong", ext: ".png" },
            { word: "Young", ext: ".png" }
        ],
        "Places": [
            { word: "Bank", ext: ".png" }, { word: "Brazil", ext: ".jpg" }, { word: "Church", ext: ".png" },
            { word: "Cinema", ext: ".jpg" }, { word: "Home", ext: ".jpg" }, { word: "Hospital", ext: ".png" },
            { word: "Restaurant", ext: ".jpg" }, { word: "School", ext: ".jpg" }, { word: "Station", ext: ".jpg" },
            { word: "Supermarket", ext: ".jpg" }, { word: "Swimming pool", ext: ".png" }
        ],
        "Others": [
            { word: "Bag", ext: ".jpg" }, { word: "Behind", ext: ".jpg" }, { word: "Between", ext: ".jpg" },
            { word: "Birthday", ext: ".jpg" }, { word: "Box", ext: ".png" }, { word: "Car", ext: ".jpg" },
            { word: "Cloudy", ext: ".png" }, { word: "Computer", ext: ".png" }, { word: "Football", ext: ".png" },
            { word: "Guitar", ext: ".png" }, { word: "In", ext: ".jpg" }, { word: "In front of", ext: ".jpg" },
            { word: "Mobile phone", ext: ".png" }, { word: "Next to", ext: ".jpg" }, { word: "On", ext: ".jpg" },
            { word: "Raining", ext: ".png" }, { word: "Snowing", ext: ".png" }, { word: "Sunny", ext: ".png" },
            { word: "Train", ext: ".jpg" }, { word: "Under", ext: ".jpg" }, { word: "Wendy", ext: ".png" },
            { word: "With", ext: ".png" }, { word: "Without", ext: ".png" }
        ],
        "Time": [
            { word: "Monday", ext: ".png" }, { word: "Tuesday", ext: ".png" }, { word: "Wednesday", ext: ".png" },
            { word: "Thursday", ext: ".png" }, { word: "Friday", ext: ".png" }, { word: "Saturday", ext: ".png" },
            { word: "January", ext: ".png" }, { word: "February", ext: ".png" }, { word: "March", ext: ".png" },
            { word: "April", ext: ".png" }, { word: "May", ext: ".png" }, { word: "June", ext: ".png" },
            { word: "July", ext: ".png" }, { word: "August", ext: ".png" }, { word: "September", ext: ".png" },
            { word: "October", ext: ".png" }, { word: "November", ext: ".png" }, { word: "December", ext: ".png" },
            { word: "Today", ext: ".png" }, { word: "Tomorrow", ext: ".png" }, { word: "Yesterday", ext: ".png" }
        ],
        "Verbs": [
            { word: "Have", ext: ".png" }, { word: "Do", ext: ".png" }, { word: "Know", ext: ".png" },
            { word: "Go", ext: ".png" }, { word: "Say", ext: ".png" }, { word: "Think", ext: ".png" },
            { word: "See", ext: ".png" }, { word: "Want", ext: ".png" }, { word: "Take", ext: ".png" },
            { word: "Look", ext: ".png" }, { word: "Use", ext: ".png" }, { word: "Come", ext: ".png" },
            { word: "Need", ext: ".png" }, { word: "Mean", ext: ".png" }, { word: "Give", ext: ".png" },
            { word: "Start", ext: ".png" }, { word: "Try", ext: ".png" }, { word: "Work", ext: ".png" },
            { word: "Tell", ext: ".png" }, { word: "Wake up", ext: ".png" }, { word: "Sleep", ext: ".png" },
            { word: "Buy", ext: ".png" }, { word: "Write", ext: ".png" }, { word: "Play", ext: ".png" },
            { word: "Drink", ext: ".png" }, { word: "Eat", ext: ".png" }, { word: "Speak", ext: ".png" },
            { word: "Put", ext: ".png" }, { word: "Add", ext: ".png" }, { word: "Travel", ext: ".png" },
            { word: "Arrive", ext: ".png" }, { word: "Enter", ext: ".png" }, { word: "Walk", ext: ".png" },
            { word: "Run", ext: ".png" }, { word: "Stand up", ext: ".png" }, { word: "Sit down", ext: ".png" },
            { word: "Hear", ext: ".png" }, { word: "Listen", ext: ".png" }, { word: "Help", ext: ".png" },
            { word: "Search", ext: ".png" }, { word: "Find", ext: ".png" }, { word: "Read", ext: ".png" },
            { word: "Can", ext: ".png" }, { word: "Understand", ext: ".png" }, { word: "Open", ext: ".png" },
            { word: "Close", ext: ".png" }, { word: "Remember", ext: ".png" }, { word: "Wait", ext: ".png" }
        ]
    };

    function getThemeProgress() {
        try {
            const progress = JSON.parse(localStorage.getItem(PROGRESS_KEY)) || {};
            // --- DEMO MODE DEACTIVATED ---
            return progress;
        } catch (e) {
            return {};
        }
    }

    function setThemeLevel(theme, level) {
        const progress = getThemeProgress();
        progress[theme] = level;
        localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));
    }

    const App = {
        state: {
            currentScreen: 'HOME',
            score: 0.0,
            themeScore: 0.0,
            currentCategory: null,
            currentLevel: 1,
            currentWord: null, 
            categoryWordsQueue: [],
            currentQuestionWords: [],
            isAwaitingAnswer: false,
            currentQuestionNumber: 0,
            totalQuestions: 0,
            maxPossibleScore: 0
        },
        
        dom: {
            scoreDisplay: document.getElementById('score'),
            progressBarFill: document.getElementById('progress-scale-fill'),
            homeScreen: document.getElementById('home-screen'),
            level1Screen: document.getElementById('level1-screen'),
            level2Screen: document.getElementById('level2-screen'),
            level3Screen: document.getElementById('level3-screen'),
            levelCompleteScreen: document.getElementById('level-complete-screen'),
            categoryList: document.getElementById('category-list'),
            backToHomeBtn: document.getElementById('back-to-home-btn'),
            mainTitle: document.getElementById('main-title'),
            
            // L1
            currentThemeTitle1: document.getElementById('current-theme-title-1'),
            ttsBtn1: document.getElementById('tts-btn-1'),
            ttsIcon1: document.getElementById('tts-icon-1'),
            imageOptionsContainer: document.getElementById('image-options-container'),
            feedbackText1: document.getElementById('feedback-text-1'),
            nextLevel1Btn: document.getElementById('next-level1-btn'),
            currentQuestionCount1: document.getElementById('current-question-count-1'),
            totalQuestionCount1: document.getElementById('total-question-count-1'),
            l1Instruction: document.getElementById('l1-instruction'),

            // L2
            currentThemeTitle2: document.getElementById('current-theme-title-2'),
            targetImage2: document.getElementById('target-image-2'),
            audioOptionsContainer: document.getElementById('audio-options-container'),
            feedbackText2: document.getElementById('feedback-text-2'),
            nextLevel2Btn: document.getElementById('next-level2-btn'),
            currentQuestionCount2: document.getElementById('current-question-count-2'),
            totalQuestionCount2: document.getElementById('total-question-count-2'),
            level2PlayBtns: [],
            level2SelectBtns: [],
            l2Instruction: document.getElementById('l2-instruction'),
            
            // L3
            currentThemeTitle3: document.getElementById('current-theme-title-3'),
            targetImage3: document.getElementById('target-image-3'),
            micBtn3: document.getElementById('mic-btn-3'),
            ttsHintBtn3: document.getElementById('tts-hint-btn-3'),
            micIcon3: document.getElementById('mic-icon-3'),
            recognitionStatus: document.getElementById('recognition-status'),
            feedbackText3: document.getElementById('feedback-text-3'),
            nextLevel3Btn: document.getElementById('next-level3-btn'),
            currentQuestionCount3: document.getElementById('current-question-count-3'),
            totalQuestionCount3: document.getElementById('total-question-count-3'),
            l3Instruction: document.getElementById('l3-instruction'),
            
            // Complete
            completedTheme: document.getElementById('completed-theme'),
            themeScoreDisplay: document.getElementById('theme-score'),
            nextLevelMessage: document.getElementById('next-level-message'),
        },

        init() {
            // Calculate total unique words
            const totalUniqueWords = Object.values(WORD_DATA_DETAILS).reduce((acc, cat) => acc + cat.length, 0);
            this.state.maxPossibleScore = totalUniqueWords * 3;

            this.dom.level2PlayBtns = Array.from(this.dom.audioOptionsContainer.querySelectorAll('.level2-play-btn'));
            this.dom.level2SelectBtns = Array.from(this.dom.audioOptionsContainer.querySelectorAll('.level2-select-btn'));
            
            this.dom.backToHomeBtn.addEventListener('click', () => this.showHomeScreen());
            this.dom.ttsBtn1.addEventListener('click', () => this.speakWord(this.state.currentWord.word));
            this.dom.nextLevel1Btn.addEventListener('click', () => this.loadNextLevel1Question());
            this.dom.nextLevel2Btn.addEventListener('click', () => this.loadNextLevel2Question());
            
            this.dom.micBtn3.addEventListener('click', () => this.startSpeechRecognition());
            this.dom.ttsHintBtn3.addEventListener('click', () => this.speakWord(this.state.currentWord.word));
            this.dom.nextLevel3Btn.addEventListener('click', () => this.loadNextLevel3Question());
            document.getElementById('skip-level3-btn').addEventListener('click', () => this.skipCurrentQuestion());

            if (recognition) {
                recognition.onresult = this.handleRecognitionResult.bind(this);
                recognition.onend = this.handleRecognitionEnd.bind(this);
                recognition.onerror = this.handleRecognitionError.bind(this);
            }

            this.showHomeScreen();
        },

        updateScreen() {
            const screens = [this.dom.homeScreen, this.dom.level1Screen, this.dom.level2Screen, this.dom.level3Screen, this.dom.levelCompleteScreen];
            screens.forEach(s => s.classList.add('hidden'));
            this.dom.backToHomeBtn.classList.remove('hidden');
            
            // Remove main title if not on HOME
            if (this.state.currentScreen === 'HOME') {
                this.dom.mainTitle.classList.remove('hidden');
            } else {
                this.dom.mainTitle.classList.add('hidden');
            }

            switch (this.state.currentScreen) {
                case 'HOME': this.dom.homeScreen.classList.remove('hidden'); this.dom.backToHomeBtn.classList.add('hidden'); break;
                case 'LEVEL1': this.dom.level1Screen.classList.remove('hidden'); break;
                case 'LEVEL2': this.dom.level2Screen.classList.remove('hidden'); break;
                case 'LEVEL3': this.dom.level3Screen.classList.remove('hidden'); break;
                case 'LEVEL_COMPLETE': this.dom.levelCompleteScreen.classList.remove('hidden'); break;
            }
            this.updateGlobalScore();
        },

        updateGlobalScore() {
            this.dom.scoreDisplay.textContent = this.state.score.toFixed(1);
            if (this.state.maxPossibleScore > 0) {
                const percentage = (this.state.score / this.state.maxPossibleScore) * 100;
                this.dom.progressBarFill.style.width = `${Math.min(percentage, 100)}%`;
            }
        },

        showHomeScreen() {
            this.state.currentScreen = 'HOME';
            this.updateScreen();
            
            let categories = Object.keys(WORD_DATA_DETAILS).sort();
            categories = categories.filter(c => c !== "Others");
            categories.push("Others");

            this.dom.categoryList.innerHTML = '';
            const progress = getThemeProgress();

            categories.forEach(category => {
                const currentLevel = progress[category] || 1;
                const wordCount = WORD_DATA_DETAILS[category].length;
                let buttonClass = 'game-button';
                if (currentLevel >= 4) buttonClass += ' mastered-final';
                else if (currentLevel >= 3) buttonClass += ' mastered';
                else if (currentLevel >= 2) buttonClass += ' unlocked';
                else buttonClass += ' default';
                
                const btn = document.createElement('button');
                btn.textContent = `${category} (${wordCount})`; 
                btn.className = buttonClass;
                btn.onclick = () => this.startLevel(category, currentLevel);
                this.dom.categoryList.appendChild(btn);
            });
        },
        
        startLevel(category, currentLevel) {
            this.state.currentCategory = category;
            this.state.themeScore = 0.0;
            this.state.currentLevel = currentLevel;

            if (currentLevel >= 4) {
                this.showComplete(3);
                return;
            }

            const initialWords = WORD_DATA_DETAILS[category];
            this.state.categoryWordsQueue = [...initialWords, ...initialWords].sort(() => Math.random() - 0.5); 
            this.state.totalQuestions = this.state.categoryWordsQueue.length;
            this.state.currentQuestionNumber = 0;

            if (currentLevel === 1) {
                this.state.currentScreen = 'LEVEL1';
                this.dom.currentThemeTitle1.textContent = `${category} - Level 1`;
                this.loadNextLevel1Question();
            } else if (currentLevel === 2) {
                this.state.currentScreen = 'LEVEL2';
                this.dom.currentThemeTitle2.textContent = `${category} - Level 2`;
                this.loadNextLevel2Question();
            } else {
                this.state.currentScreen = 'LEVEL3';
                this.dom.currentThemeTitle3.textContent = `${category} - Level 3`;
                this.loadNextLevel3Question();
            }
            this.updateScreen();
        },

        loadNextLevel1Question() {
            if (this.state.categoryWordsQueue.length === 0) { this.finishLevel1(); return; }
            this.state.currentQuestionNumber++;
            this.dom.currentQuestionCount1.textContent = this.state.currentQuestionNumber;
            this.dom.totalQuestionCount1.textContent = this.state.totalQuestions;
            
            // Only show instruction on the first question
            this.dom.l1Instruction.classList.toggle('hidden', this.state.currentQuestionNumber > 1);

            this.state.isAwaitingAnswer = true;
            this.dom.nextLevel1Btn.classList.add('hidden');
            this.dom.feedbackText1.textContent = '';
            this.state.currentWord = this.state.categoryWordsQueue.pop();
            const distractors = this.getRandomWordObjects(WORD_DATA_DETAILS[this.state.currentCategory], this.state.currentWord, 2);
            this.state.currentQuestionWords = [this.state.currentWord, ...distractors].sort(() => Math.random() - 0.5);
            this.renderLevel1ImageOptions();
            this.speakWord(this.state.currentWord.word);
        },

        renderLevel1ImageOptions() {
            this.dom.imageOptionsContainer.innerHTML = '';
            this.state.currentQuestionWords.forEach(wordObject => {
                const img = document.createElement('img');
                img.className = 'image-option';
                img.src = this.getWordImageUrl(this.state.currentCategory, wordObject);
                img.onclick = () => {
                    this.speakWord(wordObject.word);
                    if (this.state.isAwaitingAnswer) this.checkLevel1Answer(wordObject.word, img);
                };
                this.dom.imageOptionsContainer.appendChild(img);
            });
        },

        checkLevel1Answer(selectedWord, selectedImage) {
            if (selectedWord === this.state.currentWord.word) {
                this.state.isAwaitingAnswer = false;
                selectedImage.classList.add('correct');
                this.state.score += 0.5; this.state.themeScore += 0.5;
                this.updateGlobalScore();
                this.dom.feedbackText1.textContent = `Correct: ${this.state.currentWord.word} !`;
                this.dom.feedbackText1.className = 'text-lg font-bold text-green-600';
                this.dom.nextLevel1Btn.classList.remove('hidden');
            } else {
                selectedImage.classList.add('incorrect');
                this.dom.feedbackText1.textContent = `Wrong. Try again!`;
                this.dom.feedbackText1.className = 'text-lg font-bold text-red-600';
            }
        },

        loadNextLevel2Question() {
            if (this.state.categoryWordsQueue.length === 0) { this.finishLevel2(); return; }
            this.state.currentQuestionNumber++;
            this.dom.currentQuestionCount2.textContent = this.state.currentQuestionNumber;
            this.dom.totalQuestionCount2.textContent = this.state.totalQuestions;

            // Only show instruction on the first question
            this.dom.l2Instruction.classList.toggle('hidden', this.state.currentQuestionNumber > 1);

            this.state.isAwaitingAnswer = true;
            this.dom.nextLevel2Btn.classList.add('hidden');
            this.dom.feedbackText2.textContent = '';
            this.state.currentWord = this.state.categoryWordsQueue.pop();
            const distractors = this.getRandomWordObjects(WORD_DATA_DETAILS[this.state.currentCategory], this.state.currentWord, 2);
            this.state.currentQuestionWords = [this.state.currentWord, ...distractors].sort(() => Math.random() - 0.5);
            
            this.dom.targetImage2.src = this.getWordImageUrl(this.state.currentCategory, this.state.currentWord);
            this.dom.level2SelectBtns.forEach((btn, idx) => {
                btn.classList.remove('correct', 'incorrect');
                const word = this.state.currentQuestionWords[idx].word;
                this.dom.level2PlayBtns[idx].onclick = () => this.speakWord(word);
                btn.onclick = () => this.checkLevel2Answer(word, btn);
            });
        },

        checkLevel2Answer(selectedWord, selectedButton) {
            if (!this.state.isAwaitingAnswer) {
                this.speakWord(selectedWord);
                return;
            }

            this.speakWord(selectedWord);
            if (selectedWord === this.state.currentWord.word) {
                this.state.isAwaitingAnswer = false;
                selectedButton.classList.add('correct');
                this.state.score += 0.5; this.state.themeScore += 0.5;
                this.updateGlobalScore();
                this.dom.feedbackText2.textContent = `Correct: ${this.state.currentWord.word} !`;
                this.dom.feedbackText2.className = 'text-lg font-bold text-green-600';

                if (this.state.categoryWordsQueue.length > 0) {
                    this.dom.nextLevel2Btn.classList.remove('hidden');
                } else {
                    setTimeout(() => this.finishLevel2(), 1500);
                }
            } else {
                selectedButton.classList.add('incorrect');
                this.dom.feedbackText2.textContent = `Wrong. Try again!`;
                this.dom.feedbackText2.className = 'text-lg font-bold text-red-600';
            }
        },

        startLevel3(category) {
            if (!recognition) { alert("Speech Recognition not supported."); this.showHomeScreen(); return; }
            this.state.currentScreen = 'LEVEL3';
            this.dom.currentThemeTitle3.textContent = `${category} - Level 3`;
            this.loadNextLevel3Question();
        },
        
        loadNextLevel3Question() {
            if (this.state.categoryWordsQueue.length === 0) { this.finishLevel3(); return; }
            this.state.currentQuestionNumber++;
            this.dom.currentQuestionCount3.textContent = this.state.currentQuestionNumber;
            this.dom.totalQuestionCount3.textContent = this.state.totalQuestions;

            // Only show instruction on the first question
            this.dom.l3Instruction.classList.toggle('hidden', this.state.currentQuestionNumber > 1);

            this.state.isAwaitingAnswer = true;
            this.dom.nextLevel3Btn.classList.add('hidden');
            document.getElementById('skip-level3-btn').classList.remove('hidden');
            this.dom.feedbackText3.textContent = '';
            this.state.currentWord = this.state.categoryWordsQueue.pop();
            this.dom.targetImage3.src = this.getWordImageUrl(this.state.currentCategory, this.state.currentWord);
            this.dom.recognitionStatus.textContent = 'Pronounce the word you see.';
        },
        
        startSpeechRecognition() {
            try {
                recognition.start();
                this.dom.micBtn3.classList.add('recording');
                this.dom.recognitionStatus.textContent = 'Listening...';
            } catch (e) { console.error(e); }
        },

        handleRecognitionResult(event) {
            let recognized = event.results[0][0].transcript.trim().toLowerCase();
            const target = this.state.currentWord.word.toLowerCase();
            this.dom.micBtn3.classList.remove('recording');
            if (recognized === target || recognized.replace(/[- ]/g, '') === target.replace(/[- ]/g, '')) {
                this.state.isAwaitingAnswer = false;
                this.state.score += 0.5; this.state.themeScore += 0.5;
                this.updateGlobalScore();
                this.dom.feedbackText3.textContent = `Success! You said "${this.state.currentWord.word}"`;
                this.dom.feedbackText3.className = 'text-lg font-bold text-green-600';
                this.dom.nextLevel3Btn.classList.remove('hidden');
                document.getElementById('skip-level3-btn').classList.add('hidden');
            } else {
                this.dom.feedbackText3.textContent = `Recognized: "${recognized}". Try again!`;
                this.dom.feedbackText3.className = 'text-lg font-bold text-red-600';
            }
        },

        handleRecognitionEnd() { this.dom.micBtn3.classList.remove('recording'); },
        handleRecognitionError() { this.dom.recognitionStatus.textContent = 'Mic error. Try again.'; },

        skipCurrentQuestion() {
            this.state.isAwaitingAnswer = false;
            const current = this.state.currentLevel;
            if (current === 1) this.loadNextLevel1Question();
            else if (current === 2) this.loadNextLevel2Question();
            else this.loadNextLevel3Question();
        },

        finishLevel1() { setThemeLevel(this.state.currentCategory, 2); this.showComplete(1); },
        finishLevel2() { setThemeLevel(this.state.currentCategory, 3); this.showComplete(2); },
        finishLevel3() { setThemeLevel(this.state.currentCategory, 4); this.showComplete(3); },

        showComplete(lvl) {
            this.state.currentScreen = 'LEVEL_COMPLETE';
            this.dom.completedTheme.textContent = lvl === 3 ? `${this.state.currentCategory}` : `${this.state.currentCategory} - Level ${lvl}`;
            this.dom.themeScoreDisplay.textContent = this.state.themeScore.toFixed(1);
            this.dom.nextLevelMessage.textContent = lvl === 3 ? "Congratulations! You have mastered this theme!" : `Level ${lvl+1} unlocked!`;
            this.updateScreen();
        },

        getWordImageUrl(cat, wordObj) {
            return `${BASE_IMAGE_URL}${cat}_${wordObj.word}${wordObj.ext}`.replace(/ /g, '%20');
        },

        getRandomWordObjects(list, exclude, count) {
            const filtered = list.filter(w => w.word !== exclude.word);
            return filtered.sort(() => 0.5 - Math.random()).slice(0, count);
        },

        speakWord(text) {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-GB';
                window.speechSynthesis.speak(u);
            }
        }
    };

    window.onload = () => App.init();
</script>

</body>
</html>
